<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üî¥ Real-time Call Monitor - Voice Phishing Detection</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        body {
            background: linear-gradient(135deg, #071021 0%, #0d1830 100%);
            color: #e6eef6;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            min-height: 100vh;
        }
        
        .header {
            background: rgba(255,255,255,0.05);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid rgba(255,255,255,0.1);
            padding: 20px 0;
        }
        
        .call-status {
            padding: 20px;
            margin: 15px 0;
            border-radius: 12px;
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(255,255,255,0.1);
            backdrop-filter: blur(10px);
        }
        
        .call-status.active {
            border-left: 4px solid #00d4aa;
            background: rgba(0, 212, 170, 0.1);
        }
        
        .call-status.inactive {
            border-left: 4px solid #666;
            background: rgba(102, 102, 102, 0.1);
        }
        
        .live-indicator {
            color: #ff4c4c;
            animation: pulse 2s infinite;
            font-weight: bold;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.3; }
        }
        
        .alert-high {
            background: rgba(255, 76, 76, 0.2);
            border: 1px solid rgba(255, 76, 76, 0.5);
            border-left: 4px solid #ff4c4c;
        }
        
        .alert-medium {
            background: rgba(255, 183, 77, 0.2);
            border: 1px solid rgba(255, 183, 77, 0.5);
            border-left: 4px solid #ffb74d;
        }
        
        .transcript-item {
            padding: 15px;
            margin: 10px 0;
            border-radius: 8px;
            background: rgba(255,255,255,0.03);
            border-left: 3px solid #00d4aa;
            transition: all 0.3s ease;
        }
        
        .transcript-item:hover {
            background: rgba(255,255,255,0.08);
            transform: translateX(5px);
        }
        
        .phishing-score {
            font-weight: bold;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.9em;
        }
        
        .score-low { background: rgba(0, 212, 170, 0.2); color: #00d4aa; }
        .score-medium { background: rgba(255, 183, 77, 0.2); color: #ffb74d; }
        .score-high { background: rgba(255, 76, 76, 0.2); color: #ff4c4c; }
        
        .stats-card {
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 12px;
            padding: 20px;
            text-align: center;
        }
        
        .stats-number {
            font-size: 2em;
            font-weight: bold;
            color: #00d4aa;
        }
        
        .connection-status {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 10px 15px;
            border-radius: 20px;
            font-size: 0.9em;
            z-index: 1000;
        }
        
        .connected {
            background: rgba(0, 212, 170, 0.2);
            color: #00d4aa;
            border: 1px solid #00d4aa;
        }
        
        .disconnected {
            background: rgba(255, 76, 76, 0.2);
            color: #ff4c4c;
            border: 1px solid #ff4c4c;
        }
        
        .control-panel {
            background: rgba(255,255,255,0.05);
            border-radius: 12px;
            padding: 20px;
            margin: 20px 0;
        }
        
        .btn-custom {
            background: rgba(0, 212, 170, 0.2);
            border: 1px solid #00d4aa;
            color: #00d4aa;
            transition: all 0.3s ease;
        }
        
        .btn-custom:hover {
            background: #00d4aa;
            color: #071021;
        }
        
        .btn-danger-custom {
            background: rgba(255, 76, 76, 0.2);
            border: 1px solid #ff4c4c;
            color: #ff4c4c;
        }
        
        .btn-danger-custom:hover {
            background: #ff4c4c;
            color: white;
        }
        
        .scrollable {
            max-height: 400px;
            overflow-y: auto;
        }
        
        .scrollable::-webkit-scrollbar {
            width: 6px;
        }
        
        .scrollable::-webkit-scrollbar-track {
            background: rgba(255,255,255,0.05);
        }
        
        .scrollable::-webkit-scrollbar-thumb {
            background: rgba(0, 212, 170, 0.5);
            border-radius: 3px;
        }
        
        .alert-notification {
            position: fixed;
            top: 80px;
            right: 20px;
            max-width: 350px;
            z-index: 1001;
            animation: slideIn 0.5s ease;
        }
        
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
    </style>
</head>
<body>
    <div class="connection-status" id="connectionStatus">
        <i class="fas fa-circle"></i> Connecting...
    </div>

    <div class="container-fluid">
        <!-- Header -->
        <div class="header">
            <div class="container">
                <div class="row align-items-center">
                    <div class="col-md-8">
                        <h2><i class="fas fa-shield-alt"></i> Real-time Call Monitor</h2>
                        <p class="mb-0">Voice Phishing Detection System</p>
                    </div>
                    <div class="col-md-4 text-end">
                        <div id="systemTime" class="h5 mb-0"></div>
                    </div>
                </div>
            </div>
        </div>

        <div class="container mt-4">
            <!-- Control Panel -->
            <div class="control-panel">
                <div class="row">
                    <div class="col-md-6">
                        <h5><i class="fas fa-phone"></i> Call Control</h5>
                        <div class="input-group mb-3">
                            <input type="text" class="form-control" id="callIdInput" 
                                   placeholder="Enter Call ID (optional)" 
                                   style="background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.2); color: #e6eef6;">
                        </div>
                        <button class="btn btn-custom me-2" onclick="startMonitoring()">
                            <i class="fas fa-play"></i> Start Monitoring
                        </button>
                        <button class="btn btn-danger-custom" onclick="stopMonitoring()">
                            <i class="fas fa-stop"></i> Stop Monitoring
                        </button>
                    </div>
                    <div class="col-md-6">
                        <h5><i class="fas fa-chart-line"></i> Quick Stats</h5>
                        <div class="row">
                            <div class="col-4">
                                <div class="stats-card">
                                    <div class="stats-number" id="activeCallsCount">0</div>
                                    <small>Active Calls</small>
                                </div>
                            </div>
                            <div class="col-4">
                                <div class="stats-card">
                                    <div class="stats-number" id="alertsCount">0</div>
                                    <small>Alerts</small>
                                </div>
                            </div>
                            <div class="col-4">
                                <div class="stats-card">
                                    <div class="stats-number" id="chunksProcessed">0</div>
                                    <small>Chunks</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Call Status -->
            <div class="row">
                <div class="col-md-6">
                    <div class="call-status inactive" id="callStatus">
                        <h5><i class="fas fa-phone-slash"></i> No Active Calls</h5>
                        <p class="mb-0">Start monitoring to see call activity</p>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="call-status" id="webSocketStatus">
                        <h5><i class="fas fa-wifi"></i> WebSocket Status</h5>
                        <p class="mb-0" id="wsStatusText">Not connected</p>
                    </div>
                </div>
            </div>

            <!-- Alerts and Transcripts -->
            <div class="row">
                <div class="col-md-6">
                    <div class="call-status">
                        <h5><i class="fas fa-exclamation-triangle"></i> Phishing Alerts</h5>
                        <div id="alertsContainer" class="scrollable">
                            <p class="text-muted">No alerts yet</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="call-status">
                        <h5><i class="fas fa-comments"></i> Live Transcripts</h5>
                        <div id="transcriptsContainer" class="scrollable">
                            <p class="text-muted">No transcripts yet</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        class CallMonitor {
            constructor() {
                this.socket = null;
                this.currentCallId = null;
                this.isMonitoring = false;
                this.stats = {
                    activeCalls: 0,
                    alerts: 0,
                    chunksProcessed: 0
                };
                
                this.initializeUI();
                this.startClock();
                this.requestNotificationPermission();
            }
            
            initializeUI() {
                this.updateConnectionStatus('disconnected', 'Not connected');
                this.updateStats();
            }
            
            startClock() {
                setInterval(() => {
                    document.getElementById('systemTime').textContent = 
                        new Date().toLocaleTimeString();
                }, 1000);
            }
            
            requestNotificationPermission() {
                if ('Notification' in window && Notification.permission === 'default') {
                    Notification.requestPermission();
                }
            }
            
            connectWebSocket(callId) {
                if (this.socket) {
                    this.socket.close();
                }
                
                const wsUrl = `ws://127.0.0.1:8000/ws/call_monitoring/${callId}`;
                this.socket = new WebSocket(wsUrl);
                
                this.socket.onopen = (event) => {
                    console.log('üîå WebSocket connected');
                    this.updateConnectionStatus('connected', 'Connected');
                    document.getElementById('wsStatusText').textContent = 
                        `Connected to call: ${callId}`;
                };
                
                this.socket.onmessage = (event) => {
                    try {
                        const data = JSON.parse(event.data);
                        this.handleWebSocketMessage(data);
                    } catch (error) {
                        console.error('‚ùå WebSocket message error:', error);
                    }
                };
                
                this.socket.onerror = (error) => {
                    console.error('‚ùå WebSocket error:', error);
                    this.updateConnectionStatus('disconnected', 'Connection error');
                };
                
                this.socket.onclose = (event) => {
                    console.log('üîå WebSocket closed');
                    this.updateConnectionStatus('disconnected', 'Disconnected');
                    document.getElementById('wsStatusText').textContent = 'Not connected';
                };
            }
            
            handleWebSocketMessage(data) {
                console.log('üì® WebSocket message:', data);
                
                switch (data.type) {
                    case 'connection_established':
                        this.handleConnectionEstablished(data);
                        break;
                        
                    case 'call_started':
                        this.handleCallStarted(data);
                        break;
                        
                    case 'analysis_update':
                        this.handleAnalysisUpdate(data);
                        break;
                        
                    case 'phishing_alert':
                        this.handlePhishingAlert(data);
                        break;
                        
                    case 'call_ended':
                        this.handleCallEnded(data);
                        break;
                        
                    case 'heartbeat':
                        // Keep connection alive
                        break;
                        
                    default:
                        console.log('Unknown message type:', data.type);
                }
            }
            
            handleConnectionEstablished(data) {
                console.log('‚úÖ Connection established for call:', data.call_id);
            }
            
            handleCallStarted(data) {
                this.stats.activeCalls = 1;
                this.updateStats();
                
                document.getElementById('callStatus').className = 'call-status active';
                document.getElementById('callStatus').innerHTML = `
                    <h5><i class="fas fa-phone"></i> <span class="live-indicator">‚óè LIVE</span> Call Active</h5>
                    <p class="mb-1"><strong>Call ID:</strong> ${data.call_id}</p>
                    <p class="mb-0"><small>Started: ${new Date(data.timestamp * 1000).toLocaleTimeString()}</small></p>
                `;
            }
            
            handleAnalysisUpdate(data) {
                this.stats.chunksProcessed++;
                this.updateStats();
                
                this.addTranscript({
                    call_id: data.call_id,
                    chunk_number: data.chunk_number,
                    transcript: data.transcript,
                    phishing_score: data.phishing_score,
                    timestamp: data.timestamp
                });
            }
            
            handlePhishingAlert(data) {
                this.stats.alerts++;
                this.updateStats();
                
                this.showPhishingAlert(data);
                this.showNotification(
                    'Phishing Call Detected!',
                    `Suspicious activity in call ${data.call_id}`,
                    'high'
                );
            }
            
            handleCallEnded(data) {
                this.stats.activeCalls = 0;
                this.updateStats();
                
                document.getElementById('callStatus').className = 'call-status inactive';
                document.getElementById('callStatus').innerHTML = `
                    <h5><i class="fas fa-phone-slash"></i> Call Ended</h5>
                    <p class="mb-1"><strong>Call ID:</strong> ${data.call_id}</p>
                    <p class="mb-1"><strong>Duration:</strong> ${Math.round(data.summary.duration)}s</p>
                    <p class="mb-0"><strong>Avg. Phishing Score:</strong> ${(data.summary.average_phishing_score * 100).toFixed(1)}%</p>
                `;
            }
            
            addTranscript(data) {
                const container = document.getElementById('transcriptsContainer');
                
                // Remove "no transcripts" message
                if (container.innerHTML.includes('No transcripts yet')) {
                    container.innerHTML = '';
                }
                
                const scoreClass = data.phishing_score > 0.6 ? 'score-high' : 
                                 data.phishing_score > 0.3 ? 'score-medium' : 'score-low';
                
                const transcriptDiv = document.createElement('div');
                transcriptDiv.className = 'transcript-item';
                transcriptDiv.innerHTML = `
                    <div class="d-flex justify-content-between align-items-start mb-2">
                        <small><strong>Chunk ${data.chunk_number}</strong></small>
                        <span class="phishing-score ${scoreClass}">
                            ${(data.phishing_score * 100).toFixed(1)}%
                        </span>
                    </div>
                    <p class="mb-1">${data.transcript || 'No transcript available'}</p>
                    <small class="text-muted">${new Date(data.timestamp * 1000).toLocaleTimeString()}</small>
                `;
                
                container.insertBefore(transcriptDiv, container.firstChild);
                
                // Keep only latest 10 transcripts
                while (container.children.length > 10) {
                    container.removeChild(container.lastChild);
                }
            }
            
            showPhishingAlert(data) {
                const container = document.getElementById('alertsContainer');
                
                // Remove "no alerts" message
                if (container.innerHTML.includes('No alerts yet')) {
                    container.innerHTML = '';
                }
                
                const alertDiv = document.createElement('div');
                alertDiv.className = `alert p-3 mb-3 ${data.severity === 'high' ? 'alert-high' : 'alert-medium'}`;
                alertDiv.innerHTML = `
                    <h6><i class="fas fa-exclamation-triangle"></i> PHISHING ALERT</h6>
                    <p class="mb-1"><strong>Call:</strong> ${data.call_id}</p>
                    <p class="mb-1"><strong>Transcript:</strong> ${data.transcript}</p>
                    <p class="mb-1"><strong>Confidence:</strong> ${(data.confidence * 100).toFixed(1)}%</p>
                    <small>${new Date(data.timestamp * 1000).toLocaleTimeString()}</small>
                `;
                
                container.insertBefore(alertDiv, container.firstChild);
                
                // Show floating notification
                this.showFloatingAlert(data);
            }
            
            showFloatingAlert(data) {
                const notification = document.createElement('div');
                notification.className = `alert alert-${data.severity === 'high' ? 'high' : 'medium'} alert-notification`;
                notification.innerHTML = `
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <h6><i class="fas fa-exclamation-triangle"></i> PHISHING DETECTED</h6>
                            <p class="mb-1">${data.transcript.substring(0, 100)}${data.transcript.length > 100 ? '...' : ''}</p>
                            <small>Confidence: ${(data.confidence * 100).toFixed(1)}%</small>
                        </div>
                        <button class="btn btn-sm" onclick="this.parentElement.parentElement.remove()" 
                                style="color: inherit; border: none; background: none;">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                `;
                
                document.body.appendChild(notification);
                
                // Auto-remove after 10 seconds
                setTimeout(() => {
                    if (notification.parentElement) {
                        notification.remove();
                    }
                }, 10000);
            }
            
            showNotification(title, body, type = 'info') {
                if ('Notification' in window && Notification.permission === 'granted') {
                    const notification = new Notification(title, {
                        body: body,
                        icon: type === 'high' ? 'üö®' : '‚ÑπÔ∏è',
                        requireInteraction: type === 'high'
                    });
                    
                    setTimeout(() => notification.close(), 5000);
                }
            }
            
            updateConnectionStatus(status, message) {
                const statusElement = document.getElementById('connectionStatus');
                statusElement.className = `connection-status ${status}`;
                statusElement.innerHTML = `<i class="fas fa-circle"></i> ${message}`;
            }
            
            updateStats() {
                document.getElementById('activeCallsCount').textContent = this.stats.activeCalls;
                document.getElementById('alertsCount').textContent = this.stats.alerts;
                document.getElementById('chunksProcessed').textContent = this.stats.chunksProcessed;
            }
            
            startMonitoring() {
                const callIdInput = document.getElementById('callIdInput');
                const callId = callIdInput.value.trim() || `call_${Date.now()}_${Math.random().toString(36).substr(2, 8)}`;
                
                this.currentCallId = callId;
                this.isMonitoring = true;
                
                console.log('üé¨ Starting monitoring for call:', callId);
                
                // Connect WebSocket
                this.connectWebSocket(callId);
                
                // Initialize call monitoring on backend
                fetch('/start_call_monitoring/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded'
                    },
                    body: `call_id=${encodeURIComponent(callId)}`
                })
                .then(response => response.json())
                .then(data => {
                    console.log('‚úÖ Backend monitoring started:', data);
                })
                .catch(error => {
                    console.error('‚ùå Failed to start backend monitoring:', error);
                });
                
                // Update UI
                callIdInput.value = callId;
                document.getElementById('callStatus').className = 'call-status active';
                document.getElementById('callStatus').innerHTML = `
                    <h5><i class="fas fa-phone"></i> <span class="live-indicator">‚óè READY</span> Monitoring Started</h5>
                    <p class="mb-1"><strong>Call ID:</strong> ${callId}</p>
                    <p class="mb-0">Waiting for audio data...</p>
                `;
            }
            
            stopMonitoring() {
                if (!this.isMonitoring) {
                    console.log('‚ö†Ô∏è No active monitoring to stop');
                    return;
                }
                
                console.log('üõë Stopping monitoring for call:', this.currentCallId);
                
                this.isMonitoring = false;
                
                // Close WebSocket
                if (this.socket) {
                    this.socket.close();
                }
                
                // Finalize call on backend
                if (this.currentCallId) {
                    fetch('/finalize_call/', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/x-www-form-urlencoded'
                        },
                        body: `call_id=${encodeURIComponent(this.currentCallId)}`
                    })
                    .then(response => response.json())
                    .then(data => {
                        console.log('‚úÖ Call finalized:', data);
                    })
                    .catch(error => {
                        console.error('‚ùå Failed to finalize call:', error);
                    });
                }
                
                // Update UI
                document.getElementById('callStatus').className = 'call-status inactive';
                document.getElementById('callStatus').innerHTML = `
                    <h5><i class="fas fa-phone-slash"></i> Monitoring Stopped</h5>
                    <p class="mb-0">Ready to start new monitoring session</p>
                `;
                
                this.currentCallId = null;
            }
        }
        
        // Global functions for buttons
        let callMonitor;
        
        function startMonitoring() {
            callMonitor.startMonitoring();
        }
        
        function stopMonitoring() {
            callMonitor.stopMonitoring();
        }
        
        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', function() {
            callMonitor = new CallMonitor();
            console.log('üöÄ Call Monitor initialized');
        });
    </script>
</body>
</html>